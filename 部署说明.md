# PaddleOCR-VL Skill 部署说明

> 让无视觉能力的大模型（如 GLM-4.7）也能"看"图片

## 背景问题

OpenWork 中的部分大模型（如智谱 GLM-4.7）本身无法识别图片。即使使用现有的 pdf/pptx skills，这些模型也看不到图像内容。

**解决方案**：部署一个轻量级本地 OCR 模型，先提取图片中的文字，再传给主模型分析。

---

## 技术选型

### 为什么选择 PaddleOCR-VL 0.9B？

| 对比项 | PaddleOCR-VL 0.9B | DeepSeek-OCR 3B |
|--------|-------------------|-----------------|
| 参数量 | **0.9B** (更小) | 3B |
| 显存需求 | 低，CPU 可跑 | 8-16GB |
| 性能榜单 | OmniDocBench #1 | 优秀 |
| macOS 兼容 | ✅ 完美 | ✅ |

### 为什么用 Ollama 而不是原生 Python？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **Ollama (推荐)** | 安装简单、API 统一、Apple Silicon 完美支持 | 需先安装 Ollama |
| Python paddleocr | 原生集成 | macOS ARM 支持不稳定 (Issue #11588) |

---

## 工作原理

```
┌─────────────┐     ┌──────────────────┐     ┌─────────────────┐
│ 用户输入    │     │ PaddleOCR-VL     │     │ 主模型          │
│ (图片/PDF)  │────▶│ (本地 Ollama)    │────▶│ (GLM-4.7等)     │
│             │     │ 提取文字         │     │ 分析处理        │
└─────────────┘     └──────────────────┘     └─────────────────┘
```

1. 用户提供图片或 PDF
2. `ocr.py` 调用本地 Ollama 运行 PaddleOCR-VL
3. 模型提取图片中的文字（支持表格、公式、109种语言）
4. 将提取的文字传给主模型进行分析

---

## 完整复现步骤

### 前置条件

- macOS (Apple Silicon 或 Intel)
- Homebrew 已安装
- Python 3.x 已安装

### 第一步：安装 Ollama

```bash
# 安装
brew install ollama

# 启动服务（开机自启）
brew services start ollama

# 或手动启动
ollama serve
```

### 第二步：下载 PaddleOCR-VL 模型

```bash
# 下载模型（约 935MB，需要几分钟）
ollama pull MedAIBase/PaddleOCR-VL:0.9b

# 验证已安装
ollama list | grep PaddleOCR
```

### 第三步：安装 Python 依赖

```bash
# 核心依赖
pip install requests pdf2image

# PDF 转图片支持
brew install poppler
```

### 第四步：创建 Skill 目录

```bash
# OpenWork 的 Skills 目录位置
SKILLS_DIR=~/Library/Application\ Support/com.differentai.openwork/workspaces/starter/.opencode/skills

# 创建 paddle-ocr 目录
mkdir -p "$SKILLS_DIR/paddle-ocr/scripts"
```

### 第五步：创建核心文件

需要创建以下文件：

```
paddle-ocr/
├── SKILL.md              # Skill 主文档
├── .gitignore
├── .env.example
└── scripts/
    ├── ocr.py            # 核心 OCR 脚本
    ├── setup_check.py    # 环境检查脚本
    └── requirements.txt
```

#### 5.1 SKILL.md

```yaml
---
name: paddle-ocr
description: |
  Lightweight OCR skill using PaddleOCR-VL (0.9B) via Ollama.
  Use when: "OCR this image", "extract text from image/PDF"
---
```

（完整内容见本目录下的 SKILL.md）

#### 5.2 scripts/ocr.py

核心逻辑：
1. 接收图片/PDF 路径
2. 如果是 PDF，用 pdf2image 转为临时图片
3. 将图片转为 base64
4. 调用 Ollama API (`POST /api/chat`) 发送图片
5. 返回 OCR 结果

关键代码片段：

```python
# 调用 Ollama API
payload = {
    "model": "MedAIBase/PaddleOCR-VL:0.9b",
    "messages": [{
        "role": "user",
        "content": prompt,
        "images": [image_base64]
    }],
    "stream": False
}

response = requests.post(
    "http://localhost:11434/api/chat",
    json=payload,
    timeout=180
)
```

（完整代码见 scripts/ocr.py）

### 第六步：验证安装

```bash
cd "$SKILLS_DIR/paddle-ocr"

# 运行环境检查
python3 scripts/setup_check.py
```

预期输出：
```
[OK] Ollama installed
[OK] Ollama server is running
[OK] PaddleOCR-VL model installed
[OK] Python package: requests
[OK] Python package: pdf2image
[OK] Poppler installed

All checks passed!
```

### 第七步：测试 OCR

```bash
# 测试图片 OCR
python3 scripts/ocr.py 测试图片.png

# 测试 PDF OCR
python3 scripts/ocr.py 测试文档.pdf

# JSON 格式输出
python3 scripts/ocr.py 图片.png --json
```

---

## 目录结构说明

### OpenWork Skills 正确位置

```
~/Library/Application Support/com.differentai.openwork/
└── workspaces/
    └── starter/
        └── .opencode/
            └── skills/           ← 所有 Skills 在这里
                ├── paddle-ocr/   ← 新增的 OCR Skill
                ├── pdf/
                ├── pptx/
                ├── docx/
                └── ...
```

### 备份位置（iCloud）

```
~/Library/Mobile Documents/com~apple~CloudDocs/AI/OPENWORK/Opencode Skills/
```

这是备份目录，不是实际运行目录。

---

## 使用示例

### 基础用法

```bash
# 进入 skill 目录
cd ~/Library/Application\ Support/com.differentai.openwork/workspaces/starter/.opencode/skills/paddle-ocr

# 图片 OCR
python3 scripts/ocr.py /path/to/image.png

# PDF OCR（自动处理多页）
python3 scripts/ocr.py /path/to/document.pdf

# 自定义提示词
python3 scripts/ocr.py table.png --prompt "提取表格数据为 markdown 格式"

# 输出为 JSON
python3 scripts/ocr.py image.png --json > result.json

# 保存到文件
python3 scripts/ocr.py doc.pdf --output extracted.txt
```

### 在代码中集成

```python
import subprocess
import json

# 调用 OCR
result = subprocess.run(
    ["python3", "scripts/ocr.py", "chart.png", "--json"],
    capture_output=True, text=True,
    cwd="/path/to/paddle-ocr"
)

# 解析结果
ocr_data = json.loads(result.stdout)
extracted_text = ocr_data["text"]

# 构建增强提示词，传给主模型
prompt = f"""
以下是从图片中提取的内容：

{extracted_text}

请分析这些数据并给出见解。
"""
```

---

## 常见问题

### Q: Ollama 连接失败？

```bash
# 检查服务状态
brew services list | grep ollama

# 重启服务
brew services restart ollama
```

### Q: 模型未找到？

```bash
# 重新下载
ollama pull MedAIBase/PaddleOCR-VL:0.9b
```

### Q: PDF 处理失败？

```bash
# 确保 poppler 已安装
brew install poppler

# 确保 pdf2image 已安装
pip install pdf2image
```

### Q: OCR 很慢？

- PaddleOCR-VL 0.9B 在 CPU 上运行，单张图片约 5-15 秒
- 大图片可能需要 20-30 秒
- PDF 每页单独处理

---

## Ollama 服务管理

### 资源占用说明

| 状态 | CPU | 内存 | 说明 |
|------|-----|------|------|
| **空闲时** | 0% | ~30MB | 只是个轻量后台服务 |
| **推理时** | 高 | ~1-2GB | 临时加载模型，用完自动释放 |

> 模型 (935MB) **不会**一直驻留内存，只有调用时才加载，用完自动卸载。

### 服务控制命令

```bash
# ========== 查看状态 ==========
# 查看 Ollama 服务是否运行
brew services list | grep ollama

# 查看详细进程信息
ps aux | grep ollama

# 查看资源占用
ps -o pid,pcpu,pmem,rss,comm -p $(pgrep ollama)

# ========== 启动服务 ==========
# 启动并设为开机自启（推荐）
brew services start ollama

# 仅本次启动（不开机自启）
ollama serve

# ========== 停止服务 ==========
# 停止服务（保留开机自启设置）
brew services stop ollama

# ========== 重启服务 ==========
brew services restart ollama

# ========== 彻底关闭（移除开机自启）==========
brew services stop ollama
# 如果想下次手动启动，不要再用 brew services start
```

### 模型管理命令

```bash
# ========== 查看已安装模型 ==========
ollama list

# ========== 删除模型（释放磁盘空间）==========
ollama rm MedAIBase/PaddleOCR-VL:0.9b

# ========== 重新下载模型 ==========
ollama pull MedAIBase/PaddleOCR-VL:0.9b

# ========== 查看模型详情 ==========
ollama show MedAIBase/PaddleOCR-VL:0.9b
```

### 推荐策略

| 场景 | 建议 |
|------|------|
| 经常用 OCR | 保持 `brew services start ollama` 开机自启 |
| 偶尔用 OCR | 需要时 `ollama serve`，用完 Ctrl+C 关闭 |
| 完全不用了 | `brew services stop ollama` + `ollama rm 模型名` |

---

## 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `OLLAMA_BASE_URL` | `http://localhost:11434` | Ollama 服务地址 |
| `PADDLEOCR_MODEL` | `MedAIBase/PaddleOCR-VL:0.9b` | 使用的模型 |

---

## 相关资源

- [PaddleOCR-VL Ollama 页面](https://ollama.com/MedAIBase/PaddleOCR-VL)
- [PaddleOCR GitHub](https://github.com/PaddlePaddle/PaddleOCR)
- [Ollama 官网](https://ollama.ai)

---

*最后更新: 2026-02-02*
